<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Envío WhatsApp (360dialog) — CSV</title>
<style>
  body{font-family:system-ui,Arial;margin:20px}
  .box{max-width:760px;border:1px solid #ddd;border-radius:12px;padding:14px}
  input{padding:8px;border:1px solid #ccc;border-radius:8px}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
  pre{background:#111;color:#eaeaea;padding:12px;border-radius:12px;overflow:auto}
</style>
</head>
<body>

<div class="box">
  <h2>Envío WhatsApp (360dialog) — CSV</h2>

  <p><b>CSV esperado:</b> phone,name<br>
  <b>Teléfono:</b> 549 + número (ej: 5491136065609)</p>

  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <div>
      <div>Template</div>
      <input id="template" value="promo_optica_cristal_01">
    </div>
    <div>
      <div>Idioma</div>
      <input id="lang" value="es_AR">
    </div>
    <div>
      <div>Tamaño lote</div>
      <input id="lot" value="50" style="width:90px">
    </div>
    <div>
      <div>Pausa (ms)</div>
      <input id="pause" value="900" style="width:90px">
    </div>
  </div>

  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <input type="file" id="file" accept=".csv">
    <button id="btnLoad">Cargar CSV</button>
    <button id="btnSend">Enviar</button>
    <button id="btnPing">Probar ping</button>
  </div>

  <div style="margin-top:10px">
    <div>Contactos leídos: <b id="cRead">0</b> | Válidos: <b id="cOk">0</b></div>
  </div>
</div>

<h3>Log</h3>
<pre id="log"></pre>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzTtvjlTXqIeGJRK2qdll4ubGogviRbFDIPylodLINuu_z-WB9GOPmSILWc0AzT4Qz2/exec";

const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }

let contacts = [];

function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if (lines.length <= 1) return [];
  const out = [];
  for (let i=1;i<lines.length;i++){
    const parts = lines[i].split(",");
    const phone = (parts[0]||"").trim();
    const name  = (parts[1]||"").trim();
    if (phone) out.push({phone, name});
  }
  return out;
}

async function postForm(params){
  // FORM-URLENCODED -> Simple Request -> NO preflight
  const body = new URLSearchParams(params);

  // OJO: por CORS quizá no puedas leer la respuesta, pero el envío se ejecuta igual.
  // Igual intentamos leerla; si falla, no pasa nada.
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body
  });

  // Si CORS bloquea lectura, esto puede tirar error. Lo atrapamos arriba.
  return res.json();
}

document.getElementById("btnLoad").onclick = async ()=>{
  const f = document.getElementById("file").files[0];
  if (!f) return alert("Elegí un CSV");
  const text = await f.text();
  contacts = parseCSV(text);

  document.getElementById("cRead").textContent = contacts.length;
  document.getElementById("cOk").textContent = contacts.length;

  log("CSV cargado.");
  log("Leídos: " + contacts.length);
};

document.getElementById("btnPing").onclick = async ()=>{
  log("Ping...");
  try{
    const r = await fetch(API_URL + "?action=ping").then(x=>x.json());
    log("PING OK: " + JSON.stringify(r));
  }catch(e){
    log("PING ERROR (CORS no afecta al ping normalmente): " + e);
  }
};

document.getElementById("btnSend").onclick = async ()=>{
  if (!contacts.length) return alert("Primero cargá un CSV");

  const template = document.getElementById("template").value.trim();
  const lang = document.getElementById("lang").value.trim();
  const lot = document.getElementById("lot").value.trim();
  const pause = document.getElementById("pause").value.trim();

  log("Iniciando envío...");
  log(`Template: ${template} | Lang: ${lang} | Lote: ${lot} | Pausa: ${pause}ms`);
  log("TIP: La confirmación REAL queda en la hoja LOG del Apps Script.");

  try{
    const r = await postForm({
      action: "send_batch",
      template,
      lang,
      lot,
      pause,
      csv: JSON.stringify(contacts)
    });
    log("RESP: " + JSON.stringify(r));
    log("Envío terminado.");
  }catch(e){
    // Si te bloquea CORS leyendo respuesta, igual el envío se disparó.
    log("No pude leer la respuesta (CORS). Igual revisá la hoja LOG del Script.");
    log("Detalle: " + e);
    log("Envío disparado (si tu WebApp está OK).");
  }
};
</script>

</body>
</html>
