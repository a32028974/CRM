<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√ìptica Cristal ‚Ä¢ Env√≠o WhatsApp</title>
</head>
<body style="font-family:system-ui;max-width:920px;margin:24px auto;padding:0 12px;">
  <h2>Env√≠o WhatsApp (360dialog) ‚Äî CSV</h2>

  <p>
    CSV esperado: <code>phone</code>, <code>name</code> (como tu <b>export.csv</b>).<br>
    Se env√≠a usando <b>template aprobado</b>.
  </p>

  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
    <label>
      <div>Template</div>
      <input id="tpl" value="promo_optica_cristal_01" style="width:260px;padding:8px;">
    </label>

    <label>
      <div>Idioma</div>
      <input id="lang" value="es_AR" style="width:120px;padding:8px;">
    </label>

    <label>
      <div>Tama√±o lote</div>
      <input id="batchSize" type="number" value="200" min="1" max="500" style="width:120px;padding:8px;">
    </label>

    <label>
      <div>Pausa (ms)</div>
      <input id="pauseMs" type="number" value="900" min="0" max="10000" style="width:120px;padding:8px;">
    </label>
  </div>

  <div style="margin:14px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <input id="file" type="file" accept=".csv" />
    <button id="load" style="padding:9px 12px;">Cargar CSV</button>
    <button id="send" disabled style="padding:9px 12px;">Enviar</button>
    <button id="stop" disabled style="padding:9px 12px;">Detener</button>
    <button id="ping" style="padding:9px 12px;">Probar ping</button>
  </div>

  <div style="padding:10px;border:1px solid #ddd;border-radius:10px;">
    <div><b>Contactos le√≠dos:</b> <span id="count">0</span></div>
    <div><b>V√°lidos:</b> <span id="valid">0</span></div>
    <div><b>Enviados (estimado):</b> <span id="ok">0</span></div>
    <div><b>Estado:</b> <span id="status">‚Äî</span></div>
    <div style="margin-top:6px;font-size:13px;color:#555;">
      Nota: por CORS (GitHub Pages), el navegador no puede leer la respuesta del Apps Script.
      La confirmaci√≥n real est√° en <b>Apps Script ‚Üí Registro de ejecuci√≥n</b> y/o en el tel√©fono (si llegaron).
    </div>
  </div>

  <pre id="log" style="margin-top:14px;background:#111;color:#ddd;padding:12px;border-radius:10px;overflow:auto;max-height:360px;"></pre>

<script>
  // ‚úÖ TU WEBAPP NUEVA
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxags9TvLVRK-FzU9pshhduh4oYW9RbS5bMYkDBoiNfsXggTzcUsuoJnRRg8knCB0Ys/exec";

  let contacts = [];
  let stopFlag = false;
  let sentEstimated = 0;

  const $ = (id) => document.getElementById(id);
  const log = (m) => { $("log").textContent += m + "\n"; $("log").scrollTop = 1e9; };

  function setStatus(t){ $("status").textContent = t; }
  function upd(){ $("count").textContent = contacts.length; $("ok").textContent = sentEstimated; }

  function parseCSV(text) {
    const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim() !== "");
    if (lines.length < 2) return [];
    const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g,"").toLowerCase());
    const iPhone = headers.indexOf("phone");
    const iName  = headers.indexOf("name");
    if (iPhone === -1 || iName === -1) throw new Error("El CSV debe tener headers: phone,name");

    const out = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",").map(c => c.trim().replace(/^"|"$/g,""));
      const phone = (cols[iPhone] || "").trim();
      const name  = (cols[iName]  || "").trim();
      out.push({ phone, name });
    }
    return out;
  }

  function isValidPhone(p){ return /^549\d{10}$/.test(String(p||"").trim()); }

  $("ping").onclick = () => {
    const url = WEBAPP_URL + "?action=ping";
    window.open(url, "_blank");
    log("Abriendo ping: " + url);
  };

  $("load").onclick = async () => {
    const f = $("file").files[0];
    if (!f) return alert("Eleg√≠ el export.csv primero.");
    const text = await f.text();
    let rows;
    try { rows = parseCSV(text); }
    catch(e){ return alert(e.message); }

    // Filtramos v√°lidos por seguridad
    const validRows = rows.filter(r => isValidPhone(r.phone));
    contacts = validRows;

    $("valid").textContent = validRows.length;
    $("count").textContent = rows.length;

    sentEstimated = 0; upd();
    $("send").disabled = validRows.length === 0;

    log("CSV cargado.");
    log("Le√≠dos: " + rows.length);
    log("V√°lidos (549 + 10 d√≠gitos): " + validRows.length);
    setStatus("Listo");
  };

  $("stop").onclick = () => { stopFlag = true; setStatus("Deteniendo..."); };

  // ‚úÖ POST anti-CORS:
  // - mode: "no-cors" (no bloquea el request)
  // - sin headers (evita preflight)
  async function fireAndForget(data){
    await fetch(WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(data)
    });
    // no devolvemos json porque el browser no lo puede leer en no-cors
    return true;
  }

  $("send").onclick = async () => {
    if (!WEBAPP_URL || WEBAPP_URL.includes("TU_WEBAPP_URL_AQUI")) {
      return alert("Peg√° tu WEBAPP_URL del Apps Script en el index.html");
    }

    const templateName = $("tpl").value.trim();
    const lang = $("lang").value.trim();
    const batchSize = Math.max(1, Math.min(500, Number($("batchSize").value || 200)));
    const pauseMs = Math.max(0, Number($("pauseMs").value || 900));

    if (!templateName) return alert("Pon√© el nombre del template (ej: promo_optica_cristal_01)");
    if (!contacts.length) return alert("Primero carg√° un CSV con tel√©fonos v√°lidos.");

    stopFlag = false;
    $("stop").disabled = false;
    $("send").disabled = true;

    setStatus("Enviando...");
    log("Iniciando env√≠o.");
    log("Template: " + templateName + " | Lang: " + lang + " | Lote: " + batchSize + " | Pausa: " + pauseMs + "ms");

    for (let i = 0; i < contacts.length; i += batchSize) {
      if (stopFlag) break;

      const batch = contacts.slice(i, i + batchSize);
      const loteN = Math.floor(i / batchSize) + 1;

      log(`Lote ${loteN} (${batch.length} contactos) ‚Üí enviando...`);

      try {
        // üî• dispara el env√≠o (Apps Script procesa)
        await fireAndForget({
          action: "sendBatch",
          templateName,
          lang,
          pauseMs,
          batch
        });

        // como no podemos leer respuesta, marcamos estimado
        sentEstimated += batch.length;
        upd();
        setStatus(`Enviado (estimado): ${sentEstimated}`);

        log(`Lote ${loteN} disparado. Mir√° Apps Script ‚Üí Registro de ejecuci√≥n para confirmar.`);
      } catch (e) {
        log("ERROR al disparar lote " + loteN + ": " + (e && e.message ? e.message : e));
        setStatus("Error (frontend)");
        break;
      }

      // mini respiro para no saturar el navegador
      await new Promise(r => setTimeout(r, 350));
    }

    $("stop").disabled = true;
    $("send").disabled = false;
    setStatus(stopFlag ? "Detenido" : "Terminado");
    log(stopFlag ? "Env√≠o detenido por usuario." : "Env√≠o terminado (disparado).");
    log("Confirmaci√≥n REAL: Apps Script ‚Üí Registro de ejecuci√≥n + chequear WhatsApp.");
  };
</script>
</body>
</html>
